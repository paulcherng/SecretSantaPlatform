# 前台狀態顯示邏輯

## 問題描述

**原始問題：**
當所有人都填完願望後，前台會正確關閉輸入表單。但是當管理員執行抽籤後，前台重新整理時，輸入表單又被重新開啟了。

**原因：**
前台的 `api/status` 回傳資料沒有包含 `draw_completed` 狀態，導致前台無法判斷活動是否已經抽籤完成。

## 修正內容

### 1. API 修正 (api/status.js)

**修正前：**
```javascript
// 前台使用者：只回傳基本統計
const participants = Array.isArray(data) ? data : [];
return response.status(200).json({
    count: participants.length,
    groupStatus: groupStatus,
});
```

**修正後：**
```javascript
// 前台使用者：只回傳基本統計
let participants = [];
let drawCompleted = false;

if (Array.isArray(data)) {
    participants = data;
} else if (data && typeof data === 'object') {
    participants = data.participants || [];
    drawCompleted = data.draw_completed || false;
}

return response.status(200).json({
    count: participants.length,
    groupStatus: groupStatus,
    draw_completed: drawCompleted,  // 新增
});
```

### 2. 前台邏輯修正 (index.html)

**修正前：**
```javascript
async function updateStatus(config) {
    const statusData = await response.json();
    const totalLimit = config.groups.reduce((sum, g) => sum + g.limit, 0);

    // 只檢查人數是否到齊
    if (statusData.count >= totalLimit) {
        statusText.textContent = '耶！大家都許好願了～';
        form.style.display = 'none';
        return;
    }
    // ...
}
```

**修正後：**
```javascript
async function updateStatus(config) {
    const statusData = await response.json();
    const totalLimit = config.groups.reduce((sum, g) => sum + g.limit, 0);

    // 優先檢查是否已經抽籤完成
    if (statusData.draw_completed) {
        statusText.textContent = '🎉 抽籤已完成！請查收你的魔法信件～';
        form.style.display = 'none';
        showMessage('活動已經開始囉！聖誕老人已經把任務寄給大家了～', 'success');
        return;
    }

    // 再檢查人數是否到齊
    if (statusData.count >= totalLimit) {
        statusText.textContent = '耶！大家都許好願了～等聖誕老人來抽籤囉！🎅✨';
        form.style.display = 'none';
        showMessage('太棒了！所有人都完成許願了，名額已經滿滿滿～', 'success');
        return;
    }
    // ...
}
```

## 狀態判斷邏輯

前台現在會按照以下優先順序判斷狀態：

### 1. 已抽籤完成 (最高優先級)
- **條件**：`statusData.draw_completed === true`
- **顯示**：
  - 訊息：「🎉 抽籤已完成！請查收你的魔法信件～」
  - 成功提示：「活動已經開始囉！聖誕老人已經把任務寄給大家了～」
  - 表單：隱藏
- **說明**：一旦抽籤完成，就不允許再填寫願望

### 2. 人數已滿但尚未抽籤
- **條件**：`statusData.count >= totalLimit && !statusData.draw_completed`
- **顯示**：
  - 訊息：「耶！大家都許好願了～等聖誕老人來抽籤囉！🎅✨」
  - 成功提示：「太棒了！所有人都完成許願了，名額已經滿滿滿～」
  - 表單：隱藏
- **說明**：所有人都填完了，等待管理員執行抽籤

### 3. 人數未滿
- **條件**：`statusData.count < totalLimit`
- **顯示**：
  - 訊息：「目前有 X 個人許願了～還差 Y 個人喔！」
  - 表單：顯示
  - 組別選項：顯示當前人數
- **說明**：還有名額，可以繼續填寫願望

## 資料結構

### API 回傳格式 (前台)

```json
{
  "count": 5,
  "groupStatus": {
    "1": 2,
    "2": 3
  },
  "draw_completed": false
}
```

### 資料庫格式

**未抽籤時 (陣列)：**
```json
[
  { "id": 1, "name": "小明", "email": "...", "group_id": 1, "wish": "..." },
  { "id": 2, "name": "小華", "email": "...", "group_id": 2, "wish": "..." }
]
```

**已抽籤時 (物件)：**
```json
{
  "draw_completed": true,
  "emails_sent": false,
  "participants": [
    { "id": 1, "name": "小明", "assigned_to": 2, ... },
    { "id": 2, "name": "小華", "assigned_to": 1, ... }
  ]
}
```

## 測試場景

### 場景 1：正常流程
1. 參與者 A 填寫願望 → 表單顯示，進度更新
2. 參與者 B 填寫願望 → 表單顯示，進度更新
3. 所有人填完 → 表單隱藏，顯示「等聖誕老人來抽籤」
4. 管理員執行抽籤 → 表單保持隱藏，顯示「抽籤已完成」
5. 參與者重新整理頁面 → 表單保持隱藏 ✅

### 場景 2：抽籤後訪問
1. 新參與者訪問活動連結
2. 活動已經抽籤完成
3. 顯示「抽籤已完成」訊息
4. 表單隱藏，無法填寫 ✅

### 場景 3：修改願望
1. 參與者 A 已填寫願望
2. 在抽籤前，可以重新填寫修改
3. 抽籤後，無法再修改 ✅

## 注意事項

1. **優先級很重要**：必須先檢查 `draw_completed`，再檢查人數
2. **資料格式處理**：API 需要同時處理陣列和物件兩種格式
3. **前後端一致**：前台和後台都要正確處理 `draw_completed` 狀態
4. **使用者體驗**：不同狀態要有清楚的訊息提示
